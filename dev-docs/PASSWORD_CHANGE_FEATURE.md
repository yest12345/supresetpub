# 强制修改密码功能说明

## 📋 功能概述

内测版本新增了强制修改密码功能：
- 用户首次登录时使用账户ID和默认密码
- 登录后自动检测是否需要修改密码
- 如果需要修改密码，强制跳转到修改密码页面
- 修改密码后才能正常使用系统

---

## ✅ 已实现的功能

### 1. 数据库 Schema 更新
**文件**: `prisma/schema.prisma`

- ✅ 添加 `mustChangePassword` 字段（Boolean，默认 true）
- ✅ 新创建的用户默认需要修改密码

### 2. 登录逻辑更新
**文件**: `src/app/api/auth/login/route.ts`

- ✅ 支持使用账户ID或邮箱登录
- ✅ 自动检测是否使用默认密码
- ✅ 返回 `mustChangePassword` 标记

### 3. 修改密码 API
**文件**: `src/app/api/auth/change-password/route.ts`

- ✅ 验证当前密码
- ✅ 验证新密码（不能与当前密码相同）
- ✅ 更新密码并清除 `mustChangePassword` 标记

### 4. 修改密码页面
**文件**: `src/app/auth/change-password/page.tsx`

- ✅ 美观的修改密码界面
- ✅ 密码确认验证
- ✅ 自动重定向（修改成功后）

### 5. 登录界面更新
**文件**: `src/components/AuthModal.tsx`

- ✅ 支持使用账户ID或邮箱登录
- ✅ 提示信息：内测账户使用分配的账户ID和默认密码

### 6. 全局密码检查
**文件**: `src/components/PasswordChangeGuard.tsx`

- ✅ 自动检查用户是否需要修改密码
- ✅ 如果需要修改密码，自动跳转到修改密码页面

### 7. 管理员创建用户
**文件**: `src/app/api/users/route.ts`

- ✅ 创建用户时默认使用默认密码（如果未指定）
- ✅ 新用户默认 `mustChangePassword: true`

---

## 🔧 配置说明

### 默认密码

默认密码可以通过环境变量配置：

```env
# .env 文件
DEFAULT_PASSWORD="supreset2024"
```

如果不设置，默认使用 `supreset2024`。

---

## 📝 使用流程

### 1. 管理员创建用户

1. 管理员登录系统
2. 访问"用户管理"页面
3. 点击"+ 创建新用户"
4. 填写用户信息：
   - 用户名（必填）
   - 邮箱（必填）
   - 密码（可选，留空则使用默认密码）
   - 角色（user 或 admin）
5. 点击"创建用户"

**注意**：
- 如果密码留空，系统会自动使用默认密码
- 新创建的用户默认需要修改密码

### 2. 用户首次登录

1. 用户打开登录界面
2. 输入账户ID（或邮箱）和默认密码
3. 点击"登录"
4. 系统自动检测到需要修改密码
5. 自动跳转到修改密码页面

### 3. 修改密码

1. 在修改密码页面输入：
   - 当前密码（默认密码）
   - 新密码（至少 6 个字符）
   - 确认新密码
2. 点击"修改密码"
3. 修改成功后自动跳转到首页

---

## 🔒 安全特性

### 密码验证
- ✅ 新密码至少 6 个字符
- ✅ 新密码不能与当前密码相同
- ✅ 当前密码验证
- ✅ 密码使用 bcrypt 加密存储

### 强制修改
- ✅ 首次登录必须修改密码
- ✅ 修改密码前无法访问其他页面
- ✅ 自动跳转，用户无法绕过

---

## 🗄️ 数据库迁移

需要运行数据库迁移来添加新字段：

```bash
# 生成迁移文件
npm run prisma:migrate

# 或者直接推送 schema（开发环境）
npm run prisma:push
```

迁移 SQL 示例：
```sql
ALTER TABLE users ADD COLUMN must_change_password BOOLEAN DEFAULT TRUE;
```

---

## 📊 用户状态说明

### mustChangePassword 字段

- `true`: 用户需要修改密码（首次登录）
- `false`: 用户已修改密码，可以正常使用

### 状态转换

1. **创建用户** → `mustChangePassword: true`
2. **首次登录** → 检测到默认密码 → 跳转修改密码
3. **修改密码** → `mustChangePassword: false`
4. **后续登录** → 正常使用系统

---

## 🐛 故障排除

### 问题 1: 用户无法登录

**可能原因**：
- 账户ID或密码错误
- 使用了错误的默认密码

**解决方案**：
- 确认账户ID是否正确
- 确认默认密码是否为 `supreset2024`（或环境变量配置的值）
- 检查数据库中的密码是否正确加密

### 问题 2: 修改密码后仍然跳转

**可能原因**：
- `mustChangePassword` 字段未正确更新
- 用户信息缓存问题

**解决方案**：
- 检查数据库中的 `must_change_password` 字段是否为 `false`
- 清除浏览器缓存和 Cookie，重新登录

### 问题 3: 无法创建用户

**可能原因**：
- 管理员权限问题
- 邮箱已存在

**解决方案**：
- 确认当前用户是管理员（role = 'admin'）
- 检查邮箱是否已注册

---

## 🚀 后续优化建议

### 可选功能

1. **密码强度要求**
   - 要求包含大小写字母、数字、特殊字符
   - 密码长度要求（如至少 8 个字符）

2. **密码历史**
   - 记录最近使用的密码
   - 防止重复使用旧密码

3. **密码过期**
   - 设置密码有效期（如 90 天）
   - 过期后强制修改

4. **账户锁定**
   - 多次登录失败后锁定账户
   - 需要管理员解锁

5. **登录日志**
   - 记录登录时间和 IP 地址
   - 异常登录提醒

---

## 📞 技术支持

如有问题或需要帮助，请联系项目管理员。

---

**更新日期**: 2025-01-XX  
**版本**: v1.0



