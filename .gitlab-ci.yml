# GitLab CI/CD 配置文件
# 用于自动化构建和部署 Supreset 项目

stages:
  - build
  - test
  - deploy

# 变量配置
variables:
  NODE_VERSION: "20"
  PROJECT_DIR: "/var/www/supreset@SODA/nextjs-mysql"
  PM2_APP_NAME: "supreset"

# 缓存配置
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/
    - .next/cache/

# ==================== 构建阶段 ====================
build:
  stage: build
  image: node:${NODE_VERSION}
  
  before_script:
    - echo "🔧 安装依赖..."
    - npm ci --cache .npm --prefer-offline
    
  script:
    - echo "📦 生成 Prisma Client..."
    - npm run prisma:generate || echo "⚠️ Prisma generate 跳过（需要数据库连接）"
    
    - echo "🏗️ 构建项目..."
    - npm run build
    
    - echo "✅ 构建完成"
    - ls -la .next/
    
  artifacts:
    paths:
      - .next/
      - node_modules/
      - public/
    expire_in: 1 hour
    
  only:
    - main
    - develop
    - merge_requests

# ==================== 测试阶段 ====================
lint:
  stage: test
  image: node:${NODE_VERSION}
  
  before_script:
    - npm ci --cache .npm --prefer-offline
    
  script:
    - echo "🔍 运行代码检查..."
    - npm run lint || echo "⚠️ Lint 检查完成（允许警告）"
    
  only:
    - main
    - develop
    - merge_requests

# ==================== 部署阶段 ====================
deploy:production:
  stage: deploy
  image: alpine:latest
  
  before_script:
    - apk add --no-cache openssh-client rsync
    
  script:
    - echo "🚀 开始部署到生产环境..."
    
    # 配置 SSH
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H $SERVER_HOST >> ~/.ssh/known_hosts
    
    # 部署脚本
    - |
      ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST << 'ENDSSH'
        set -e
        cd $PROJECT_DIR
        
        echo "📥 拉取最新代码..."
        git fetch gitlab main
        git reset --hard gitlab/main
        
        echo "📦 安装依赖..."
        npm ci --production
        
        echo "🔧 生成 Prisma Client..."
        npm run prisma:generate
        
        echo "📊 运行数据库迁移..."
        npm run prisma:push || echo "⚠️ 数据库迁移跳过"
        
        echo "🏗️ 构建项目..."
        npm run build
        
        echo "📁 创建上传目录..."
        mkdir -p public/uploads/{presets,covers,audio}
        chmod -R 755 public/uploads/
        
        echo "🔄 重启应用..."
        pm2 restart $PM2_APP_NAME || pm2 start npm --name $PM2_APP_NAME -- start
        
        echo "💾 保存 PM2 配置..."
        pm2 save
        
        echo "✅ 部署完成！"
      ENDSSH
    
    - echo "✅ 生产环境部署成功"
    
  environment:
    name: production
    url: https://supreset.com
    
  only:
    - main
    
  when: manual  # 手动触发部署

deploy:staging:
  stage: deploy
  image: alpine:latest
  
  before_script:
    - apk add --no-cache openssh-client rsync
    
  script:
    - echo "🚀 开始部署到测试环境..."
    
    # 配置 SSH
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H $STAGING_SERVER_HOST >> ~/.ssh/known_hosts
    
    # 部署脚本（与生产环境类似，但使用测试服务器）
    - |
      ssh -o StrictHostKeyChecking=no $STAGING_SERVER_USER@$STAGING_SERVER_HOST << 'ENDSSH'
        set -e
        cd $PROJECT_DIR
        
        echo "📥 拉取最新代码..."
        git fetch gitlab develop
        git reset --hard gitlab/develop
        
        echo "📦 安装依赖..."
        npm ci
        
        echo "🔧 生成 Prisma Client..."
        npm run prisma:generate
        
        echo "🏗️ 构建项目..."
        npm run build
        
        echo "🔄 重启应用..."
        pm2 restart $PM2_APP_NAME-staging || pm2 start npm --name $PM2_APP_NAME-staging -- start
        
        echo "✅ 测试环境部署完成！"
      ENDSSH
    
    - echo "✅ 测试环境部署成功"
    
  environment:
    name: staging
    url: https://staging.supreset.com
    
  only:
    - develop
    
  when: manual  # 手动触发部署


